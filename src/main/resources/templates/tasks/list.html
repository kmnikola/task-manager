<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tasks List</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="navbar-container">
    <div th:replace="navbar :: navbar"></div>
    <div th:if="${canEdit}">
        <div th:replace="workplace-navbar :: workplaceNavbar(${workplace_id})"></div>
    </div>
</div>

<h1>Tasks</h1>

<!-- Owner view -->

<div th:if="${canEdit}">
    <table>
        <colgroup>
            <col class="col-title">
            <col class="col-description">
            <col class="col-category">
            <col class="col-recurrence">
            <col class="col-groups">
            <col class="col-actions"> <!-- Actions -->
        <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Category</th>
            <th>Recurrence</th>
            <th>Groups</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/create'}" th:object="${task}" method="post">
                <td>
                    <input type="text" th:field="*{title}" placeholder="Task Title" required/>
                </td>
                <td>
                    <input type="text" th:field="*{description}" placeholder="Description"/>
                </td>
                <td>
                    <select name="category_id">
                        <option value="" disabled selected>Select category</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat.id}"
                                th:text="${cat.name}">
                        </option>
                    </select>
                </td>
                <td>
                    <select name="recurrence_set_id">
                        <option value="" disabled selected>Select recurrence</option>
                        <option th:each="rec : ${recurrenceSets}"
                                th:value="${rec.id}"
                                th:text="${rec.name}">
                        </option>
                    </select>
                </td>
                <td>
                    <div th:each="g : ${groups}">
                        <label>
                            <input type="checkbox"
                                   name="group_ids"
                            th:value="${g.id}">
                            <span th:text="${g.name}"></span>
                        </label>
                    </div>
                </td>
                <td>
                    <button type="submit">Add Task</button>
                </td>
            </form>
        </tr>
        <tr th:each="task : ${tasks}">
            <!-- Task Title -->
            <td th:text="${task.title}">Task Name</td>

            <!-- Description -->
            <td th:text="${task.description}">Description</td>

            <!-- Category column -->
            <td>
                <!-- Show category name or placeholder -->
                <span th:text="${task.category != null ? task.category.name : ''}"></span>

                <!-- Remove category -->
                <span class="task-elements" th:if="${task.category != null}">
                    <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/remove_category'}"
                          method="post">
                        <input type="hidden" name="task_id" th:value="${task.id}"/>
                        <button type="submit">✖</button>
                    </form>
                </span>

                <!-- Dropdown to set category if none -->
                <span th:if="${task.category == null}">
                    <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/set_category'}"
                          method="post">
                        <input type="hidden" name="task_id" th:value="${task.id}"/>
                        <select name="category_id" onchange="this.form.submit()">
                            <option value="" disabled selected>Set category</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat.id}"
                                    th:text="${cat.name}">
                            </option>
                        </select>
                    </form>
                </span>
            </td>
            <!-- Recurrence column -->
            <td>
                <span th:text="${task.recurrenceSet != null ? task.recurrenceSet.name : ''}"></span>

                <span class="task-elements" th:if="${task.recurrenceSet != null}">
                    <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/remove_recurrence_set'}"
                          method="post">
                        <input type="hidden" name="task_id" th:value="${task.id}"/>
                        <button type="submit">✖</button>
                    </form>
                </span>
                <span th:if="${task.recurrenceSet == null}">
                    <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/set_recurrence_set'}"
                          method="post">
                        <input type="hidden" name="task_id" th:value="${task.id}"/>
                        <select name="recurrence_set_id" onchange="this.form.submit()">
                            <option value="" disabled selected>Set recurrence</option>
                            <option th:each="rec : ${recurrenceSets}"
                                    th:value="${rec.id}"
                                    th:text="${rec.name}">
                            </option>
                        </select>
                    </form>
                </span>
            </td>

            <!-- Groups column -->
            <td>
                    <span th:if="${#lists.isEmpty(task.workplaceGroups)}">---</span>
                    <span class="task-elements" th:each="group : ${task.workplaceGroups}">
                        <span th:text="${group.name}"></span>
                        <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/remove_group'}"
                              method="post">
                            <input type="hidden" name="task_id" th:value="${task.id}"/>
                            <input type="hidden" name="group_id" th:value="${group.id}"/>
                            <button type="submit">✖</button>
                        </form>
                    </span>
                <!-- Add group dropdown -->
                <button type="button"
                        th:id="'add-group-btn-' + ${task.id}"
                        th:onclick="'showAddGroupDropdown(' + ${task.id} + ')'"
                        style="margin-top:0.5rem;">
                    ➕
                </button>
                <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/add_group'}"
                      method="post"
                      th:id="'add-group-form-' + ${task.id}"
                      style="display:none; margin-top:0.5rem;">
                    <input type="hidden" name="task_id" th:value="${task.id}"/>
                    <select name="group_id" onchange="this.form.submit()">
                        <option value="" disabled selected>Add group</option>
                        <option th:each="g : ${groups}"
                                th:value="${g.id}"
                                th:text="${g.name}">
                        </option>
                    </select>
                </form>
            </td>

            <!-- Actions column -->
            <td>
                <!-- Edit -->
                <a th:href="@{'/workplaces/' + ${workplace_id} + '/tasks/' + ${task.id} + '/edit'}">
                    <button type="button">✏️</button>
                </a>

                <!-- Delete -->
                <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/delete'}"
                      method="post" style="display:inline;">
                    <input type="hidden" name="task_id" th:value="${task.id}"/>
                    <button type="submit">X</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- User view  -->
<div th:if="${!canEdit}">
    <div class="category-tables-container">
        <div class="category-table-wrapper" th:each="category : ${tasksByCategory.keySet()}">

            <h2 th:text="${category != null ? category.name : 'Uncategorized'}"></h2>

            <table>
                <colgroup>
                    <col class="col-actions">
                    <col class="col-title">
                    <col class="col-description">
                </colgroup>
                <thead>
                <tr>
                    <th></th>
                    <th>Task</th>
                    <th>Description</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="task : ${tasksByCategory.get(category)}"
                    th:class="${task.active ? 'task-active' : 'task-inactive'}">
                    <td>
                        <form th:action="@{'/workplaces/' + ${workplace_id} + '/tasks/toggle-active'}"
                              method="post">
                            <input type="hidden" name="task_id" th:value="${task.id}"/>
                            <button type="submit" th:class="${task.active ? 'active-btn' : 'inactive-btn'}">✓
                            </button>
                        </form>
                    </td>
                    <td th:text="${task.title}">Task Name</td>
                    <td th:text="${task.description}">Desc</td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>
</div>
<script>
    function showAddGroupDropdown(taskId) {
        document.getElementById('add-group-btn-' + taskId).style.display = 'none';
        document.getElementById('add-group-form-' + taskId).style.display = 'flex';
    }
</script>
</body>
</html>